name: Absolute Governance with DEB Packaging and Overlord Control

on:
  pull_request:
    branches:
      - partitioned-main
    types: [opened, synchronize, reopened]

jobs:
  overlord-absolutes:
    runs-on: ubuntu-latest
    outputs:
      governance-status: ${{ steps.governance.outputs.status }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Overlord Absolute Compliance Check
        id: governance
        run: |
          echo "OVERLORD GOVERNANCE: Enforcing absolute compliance..."
          
          # Absolute requirement 1: Android project structure
          if [ ! -f "src/main/AndroidManifest.xml" ]; then
            echo "OVERLORD MANDATE VIOLATION: AndroidManifest.xml missing"
            echo "status=violated" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Absolute requirement 2: Main Activity exists
          if [ ! -f "src/main/java/com/superlab/quantumide/MainActivity.java" ]; then
            echo "OVERLORD MANDATE VIOLATION: MainActivity.java missing"
            echo "status=violated" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Absolute requirement 3: Proot-distro integration
          if [ ! -d "distro-install-rootfs" ]; then
            echo "OVERLORD MANDATE VIOLATION: distro-install-rootfs directory missing"
            echo "status=violated" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Absolute requirement 4: No hardcoded credentials
          if grep -r "ghp_\|github_token\|password.*=\|token.*=" --include="*.sh" --include="*.yml" --include="*.yaml" --include="*.json" .; then
            echo "OVERLORD SECURITY VIOLATION: Credentials detected in source"
            echo "status=violated" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Absolute requirement 5: Proper file permissions
          if find . -name "*.sh" -exec grep -l "chmod 777" {} \;; then
            echo "OVERLORD SECURITY VIOLATION: Excessive permissions detected"
            echo "status=violated" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "All overlord absolutes satisfied"
          echo "status=approved" >> $GITHUB_OUTPUT

  deb-packaging-validation:
    runs-on: ubuntu-latest
    needs: overlord-absolutes
    if: ${{ needs.overlord-absolutes.outputs.governance-status == 'approved' }}
    steps:
      - name: DEB Packaging Compliance
        run: |
          echo "DEB Packaging Governance: Validating package compliance..."
          
          # Check if packaging system is properly configured
          if [ -f "build.gradle" ]; then
            echo "Gradle build system detected - validating packaging config"
            
            # Check for proper Android packaging
            if grep -q "applicationId" app/build.gradle; then
              app_id=$(grep "applicationId" app/build.gradle | head -1 | cut -d'"' -f2)
              echo "Application ID: $app_id"
              
              # Validate app ID format
              if [[ ! "$app_id" =~ ^[a-zA-Z][a-zA-Z0-9_]*(\.[a-zA-Z][a-zA-Z0-9_]*)*$ ]]; then
                echo "PACKAGING VIOLATION: Invalid application ID format"
                exit 1
              fi
            else
              echo "PACKAGING VIOLATION: No applicationId found in build.gradle"
              exit 1
            fi
          fi

  ubuntu-base-integration:
    runs-on: ubuntu-latest
    needs: overlord-absolutes
    if: ${{ needs.overlord-absolutes.outputs.governance-status == 'approved' }}
    steps:
      - name: Ubuntu Base Integration Validation
        run: |
          echo "Ubuntu Base Integration: Validating system layer compliance..."
          
          # Check Ubuntu base layer structure
          if [ -f "distro-install-rootfs/install_ubuntu.sh" ]; then
            echo "Ubuntu installation script detected - validating content"
            
            # Check for proper Ubuntu base integration
            if grep -q "proot-distro\|chroot\|overlay" distro-install-rootfs/install_ubuntu.sh; then
              echo "Ubuntu integration: VALIDATED"
            else
              echo "UBUNTU INTEGRATION VIOLATION: No proper integration detected"
              exit 1
            fi
          else
            echo "UBUNTU INTEGRATION VIOLATION: No Ubuntu installation script found"
            exit 1
          fi

  upper-layer-validation:
    runs-on: ubuntu-latest
    needs: [overlord-absolutes, deb-packaging-validation, ubuntu-base-integration]
    steps:
      - name: Upper Layer Validation
        run: |
          echo "Upper Layer Governance: Validating application layers..."
          
          # Check for proper upper layer integration
          if [ -f "web-terminal/index.html" ]; then
            echo "Web terminal integration: VALIDATED"
          else
            echo "UPPER LAYER VIOLATION: web-terminal integration missing"
            exit 1
          fi
          
          # Check for hardened partitioned space integration
          if [ -d "core" ] && [ -d "security" ] && [ -d "lib" ]; then
            echo "Hardened partitioned space components: VALIDATED"
          else
            echo "HARDENED SPACE VIOLATION: Missing core components"
            exit 1
          fi

  overlord-final-lock:
    runs-on: ubuntu-latest
    needs: [overlord-absolutes, deb-packaging-validation, ubuntu-base-integration, upper-layer-validation]
    steps:
      - name: Overlord Absolute Final Lock
        run: |
          echo "==========================================="
          echo "OVERLORD GOVERNANCE: FINAL ABSOLUTE LOCK"
          echo "==========================================="
          echo "All absolute requirements: SATISFIED"
          echo "DEB packaging: COMPLIANT"
          echo "Ubuntu base integration: VERIFIED"
          echo "Upper layer validation: APPROVED"
          echo "Hard boundaries: MANDATORY ENFORCED"
          echo "==========================================="
          echo "FSM State: OVERLORD_ABSOLUTE_COMPLIANT"
          echo "MCP Integration: ACTIVATED"
          echo "SPIRAL Validation: CONFIRMED"
          echo "==========================================="
          
          # Create absolute governance lock
          mkdir -p .overlord-governance
          echo "OVERLORD ABSOLUTE LOCK: $(date)" > .overlord-governance/final-lock.txt
          echo "SHA: ${{ github.sha }}" >> .overlord-governance/final-lock.txt
          echo "PR: ${{ github.event.number }}" >> .overlord-governance/final-lock.txt
          echo "STATUS: MANDATORY COMPLIANCE ENFORCED" >> .overlord-governance/final-lock.txt