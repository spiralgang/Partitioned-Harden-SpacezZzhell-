name: CRDA Scan

on:
  workflow_call:
    secrets:
      CRDA_KEY:
        required: false
      SNYK_TOKEN:
        required: false
  workflow_dispatch:
  pull_request_target:
    branches: [ "main" ]
    types: [ assigned, opened, synchronize, reopened, labeled, edited ]

permissions:
  contents: read
  security-events: write    # Needed for SARIF upload
  actions: write            # Needed for artifact upload

jobs:
  crda-scan:
    permissions:
      contents: read
      security-events: write
      actions: write
    name: Scan project vulnerabilities with CRDA
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check for dependency files
        id: check-deps
        run: |
          # Check if this project has dependency files that CRDA can scan
          if find . -name "package.json" -o -name "requirements.txt" -o -name "pom.xml" -o -name "build.gradle" -o -name "Cargo.toml" -o -name "go.mod" | grep -q .; then
            echo "has_deps=true" >> $GITHUB_OUTPUT
          else
            echo "has_deps=false" >> $GITHUB_OUTPUT
            echo "No dependency files found. This appears to be a shell script/documentation project."
          fi

      - name: Skip CRDA scan for non-dependency projects
        if: steps.check-deps.outputs.has_deps == 'false'
        run: |
          echo "::notice::CRDA scan skipped - no dependency management files found"
          echo "This project appears to contain shell scripts and documentation without traditional dependencies."
          echo "CRDA scanning is not applicable to this type of project."

      - name: Install CRDA CLI
        if: steps.check-deps.outputs.has_deps == 'true'
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: github
          github_pat: ${{ github.token }}
          crda: "latest"

      - name: CRDA Scan
        if: steps.check-deps.outputs.has_deps == 'true'
        id: scan
        uses: redhat-actions/crda@v1
        with:
          crda_key: ${{ secrets.CRDA_KEY }}
          fail_on: never  # Don't fail the build on upload errors